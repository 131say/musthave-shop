# Тесты финансовых сценариев

## Описание

Комплексный набор тестов для проверки всех финансовых операций системы:
- Создание заказов
- Начисление и списание бонусов
- Возвраты товаров (частичные и полные)
- Расчет процентов кэшбэка
- Реферальная программа
- Отмена заказов

## Запуск тестов

```bash
npm run test:financial
```

или

```bash
tsx scripts/testFinancialScenarios.ts
```

## Тестовые сценарии

### 1. Заказ без бонусов (полная оплата наличными)
- **Цель**: Проверить создание заказа с полной оплатой наличными
- **Проверяет**:
  - Корректность расчета `totalAmount`, `cashPaid`, `bonusSpent`
  - Баланс пользователя не изменяется при создании заказа
  - Бонусы не списываются

### 2. Заказ с частичной оплатой бонусами
- **Цель**: Проверить создание заказа с частичной оплатой бонусами
- **Проверяет**:
  - Корректное списание бонусов из баланса
  - Правильный расчет `cashPaid` (totalAmount - bonusSpent)
  - Создание события `BONUS_SPENT`

### 3. Заказ с полной оплатой бонусами
- **Цель**: Проверить создание заказа с полной оплатой бонусами
- **Проверяет**:
  - Полное списание бонусов
  - `cashPaid = 0` при полной оплате бонусами
  - Корректность баланса после заказа

### 4. Начисление бонусов при статусе DONE
- **Цель**: Проверить начисление кэшбэка при завершении заказа
- **Проверяет**:
  - Начисление бонусов только от суммы `cashPaid` (не от `totalAmount`)
  - Правильный расчет процента кэшбэка (customerPercent)
  - Создание события `ORDER_BONUS`
  - Защиту от двойного начисления

### 5. Реферальные бонусы (пригласителю)
- **Цель**: Проверить начисление бонусов пригласителю
- **Проверяет**:
  - Начисление бонусов пользователю (customerPercent)
  - Начисление бонусов пригласителю (inviterPercent)
  - Корректность расчета процентов
  - Создание событий для обоих пользователей

### 6. Частичный возврат товаров
- **Цель**: Проверить обработку частичного возврата
- **Проверяет**:
  - Корректное уменьшение `totalAmount` и `cashPaid`
  - Пропорциональное списание начисленного кэшбэка
  - Обновление `returnedQuantity` для товаров
  - Бонусы остаются на оставшиеся товары (не возвращаются)

### 7. Полный возврат заказа
- **Цель**: Проверить обработку полного возврата
- **Проверяет**:
  - Возврат всех потраченных бонусов (`bonusSpent`)
  - Списание всего начисленного кэшбэка
  - Обнуление `bonusSpent` при полном возврате
  - Возврат баланса к исходному состоянию

### 8. Отмена выполненного заказа
- **Цель**: Проверить списание бонусов при отмене выполненного заказа
- **Проверяет**:
  - Списание всех начисленных бонусов (ORDER_BONUS)
  - Создание событий `MANUAL_ADJUSTMENT` для списания
  - Возврат баланса к состоянию до начисления бонусов

### 9. Недостаточный баланс бонусов
- **Цель**: Проверить валидацию при недостаточном балансе
- **Проверяет**:
  - Отклонение заказа при попытке списать больше бонусов, чем есть на балансе
  - Корректное сообщение об ошибке

### 10. Сложный сценарий
- **Цель**: Проверить комбинацию всех операций
- **Проверяет**:
  - Создание заказа с частичной оплатой бонусами
  - Начисление бонусов при DONE (пользователю и пригласителю)
  - Частичный возврат с пропорциональным списанием кэшбэка
  - Отмена заказа со списанием всех оставшихся бонусов
  - Корректность финальных балансов

## Настройки для тестов

Тесты используют следующие настройки (устанавливаются автоматически):
- `customerPercent`: 5% (кэшбэк покупателю)
- `inviterPercent`: 3% (бонус пригласителю)

## Что проверяется

### Финансовые расчеты
- ✅ Корректность расчета сумм заказа
- ✅ Правильность списания бонусов
- ✅ Точность начисления кэшбэка
- ✅ Пропорциональность возвратов

### Бизнес-логика
- ✅ Бонусы начисляются только от `cashPaid` (не от бонусов)
- ✅ Защита от двойного начисления
- ✅ Возврат бонусов при полном возврате
- ✅ Пропорциональное списание кэшбэка при частичном возврате

### Реферальная программа
- ✅ Начисление бонусов пользователю
- ✅ Начисление бонусов пригласителю
- ✅ Корректность расчета процентов

### Граничные случаи
- ✅ Валидация недостаточного баланса
- ✅ Обработка отмены выполненного заказа
- ✅ Множественные возвраты

## Структура тестов

Каждый тест:
1. Создает тестовых пользователей и товары
2. Выполняет операцию (создание заказа, изменение статуса, возврат)
3. Проверяет балансы и суммы
4. Выводит детальную информацию о каждом шаге
5. Возвращает результат (успех/ошибка)

## Пример вывода

```
============================================================
ТЕСТ: 1. Заказ без бонусов (полная оплата наличными)
============================================================
ℹ️  Баланс до заказа: 0
ℹ️  Создан заказ #123, сумма: 20000, бонусы: 0, наличные: 20000
ℹ️  Баланс после заказа: 0
✅ Заказ создан корректно: полная оплата наличными, баланс не изменился
```

## Важные замечания

1. **Тесты создают реальные данные** в базе данных
2. **Тесты используют тестовых пользователей** с префиксом `TEST` в referralCode
3. **Тесты не удаляют данные** после выполнения (для проверки)
4. **Все расчеты округляются** до целых чисел (тенге)

## Устранение проблем

Если тест не проходит:
1. Проверьте логи - там указаны ожидаемые и фактические значения
2. Убедитесь, что настройки в БД корректны
3. Проверьте, что нет конфликтов с существующими данными
4. Убедитесь, что база данных доступна и не заблокирована
